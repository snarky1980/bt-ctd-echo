<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ECHO - CTD gestion (Admin)</title>
  <!-- meta used for GitHub repo autodetection for JSON publish -->
  <meta name="gh-repo" content="snarky1980/echo-bt-ctd-gestion" />
    <meta property="og:title" content="ECHO - CTD gestion (Admin)" />
    <meta property="og:description" content="Console d'administration pour la gestion des mod√®les de courriels" />
    <meta name="description" content="Console d'administration pour la gestion des mod√®les de courriels" />
    <meta name="robots" content="noindex, nofollow" />
    <link rel="icon" type="image/svg+xml" href="/favicon-e.svg" />
    <style>
      :root { --border:#e2e8f0; --panel:#fff; --muted:#64748b; --ink:#0f172a; --teal:#059669; }
      *{box-sizing:border-box}
      body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f8fafc;color:var(--ink)}
      .topbar{position:sticky;top:0;z-index:10;display:flex;gap:8px;align-items:center;padding:10px;border-bottom:1px solid var(--border);background:rgba(255,255,255,.9);backdrop-filter:blur(6px)}
      .topbar .brand{font-weight:800}
      .topbar .spacer{flex:1}
      .btn{border:1px solid var(--border);background:#fff;padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer}
      .btn.primary{background:var(--teal);border-color:var(--teal);color:#fff}
  .btn.danger{background:#fef2f2;border-color:#fecaca;color:#991b1b}
        .btn.info{background:#0ea5e9;border-color:#0ea5e9;color:#fff}
        .btn.indigo{background:#6366f1;border-color:#6366f1;color:#fff}
        .btn.warning{background:#f59e0b;border-color:#fbbf24;color:#1f2937}
        .btn.neutral{background:#fff;color:#0f172a}
        .topbar .group{display:flex;gap:8px;padding:4px;border:1px solid var(--border);border-radius:12px;background:#f1f5f9}
        .dropdown{position:relative}
        .menu{display:none;position:absolute;right:0;top:44px;background:#fff;border:1px solid var(--border);border-radius:10px;box-shadow:0 8px 30px rgba(2,6,23,.12);min-width:220px;z-index:20}
        .menu .item{display:block;width:100%;text-align:left;border:0;background:transparent;padding:8px 12px}
        .menu .item + .item{border-top:1px solid var(--border)}
        /* Badge + import mode */
        #updated-badge{display:none;margin-left:6px;padding:4px 8px;font-size:11px;font-weight:700;border:1px solid #bae6fd;background:#ecfeff;color:#0e7490;border-radius:8px}
        #import-mode{margin-left:8px;border:1px solid var(--border);background:#fff;padding:4px 8px;border-radius:8px;font-weight:700;font-size:12px}
        /* Utilities */
        .span-2{grid-column:1 / span 2}
        /* Modal styling */
        #modal-category-colors{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:1000;align-items:center;justify-content:center}
        .modal-panel{background:#fff;border:1px solid var(--border);border-radius:14px;width:min(720px,92vw);max-height:85vh;display:flex;flex-direction:column}
        .modal-header{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
        .modal-close{border:0;background:transparent;font-size:18px;cursor:pointer}
        .modal-body{padding:14px;overflow:auto;flex:1}
        .modal-note{margin:0 0 12px;color:var(--muted);font-size:13px}
        #category-colors-list{display:grid;gap:10px}
        .modal-footer{padding:12px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end}
      .seg{display:inline-flex;gap:4px;border:1px solid var(--border);border-radius:10px;padding:4px;background:#f1f5f9}
      .seg button{border:0;background:transparent;padding:6px 10px;border-radius:8px;font-weight:800;color:var(--muted);cursor:pointer}
      .seg button[aria-pressed="true"]{background:#fff;color:var(--ink)}
      .frame{display:grid;grid-template-columns:320px 1fr;gap:12px;padding:12px}
      .panel{background:var(--panel);border:1px solid var(--border);border-radius:14px}
      .panel .head{padding:10px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
      .panel .body{padding:12px}
      .search{display:flex;gap:8px}
      .search input{flex:1;border:1px solid var(--border);padding:8px 10px;border-radius:10px}
      .list{display:grid;gap:8px;max-height:calc(100vh - 230px);overflow:auto;margin-top:10px}
      .tile{border:1px solid var(--border);border-radius:12px;padding:10px;background:#fff;cursor:pointer}
      .tile.active{border-color:#99f6e4;box-shadow:inset 0 0 0 2px rgba(16,185,129,.15)}
      .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
      .field{display:grid;gap:6px}
      .field label{font-size:12px;color:var(--muted);font-weight:700}
      .field input,.field textarea,.field select{border:1px solid var(--border);border-radius:10px;padding:8px 10px;font:inherit;width:100%}
      .field textarea{min-height:120px;resize:vertical}
      .toolbar{display:flex;gap:8px;flex-wrap:wrap}
      .chips{display:flex;gap:6px;flex-wrap:wrap}
      .chip{background:#ecfeff;color:#0e7490;border:1px solid #bae6fd;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:700}
      .chip.muted{opacity:.7}
      .tile-title{font-weight:700}
      .tile-sub{color:var(--muted);font-size:12px}
      /* Category colors row */
      .cat-row{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;padding:10px;border:1px solid var(--border);border-radius:10px;background:#fafafa}
      .cat-label{font-weight:700;color:#334155}
      .cat-controls{display:flex;align-items:center;gap:10px}
      .cat-preview{width:34px;height:24px;border-radius:6px;display:grid;place-items:center;font-weight:800;font-size:11px}
      .cat-color{width:60px;height:36px;border:1px solid var(--border);border-radius:6px;cursor:pointer}
      .notice{display:none;position:fixed;top:10px;right:10px;background:#111827;color:#fff;padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.1);font-weight:700;z-index:1000}
  .hidden{display:none!important}
  /* Save indicator */
  .save-indicator{position:fixed;bottom:20px;right:20px;padding:10px 16px;border-radius:12px;font-size:13px;font-weight:600;z-index:999;display:flex;align-items:center;gap:8px;transition:all 0.3s ease;opacity:0;transform:translateY(10px)}
  .save-indicator.visible{opacity:1;transform:translateY(0)}
  .save-indicator.saving{background:#fef3c7;border:1px solid #fde68a;color:#92400e}
  .save-indicator.saved{background:#dcfce7;border:1px solid #bbf7d0;color:#166534}
  .save-indicator .dot{width:8px;height:8px;border-radius:50%;animation:pulse 1s infinite}
  .save-indicator.saving .dot{background:#f59e0b}
  .save-indicator.saved .dot{background:#22c55e}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
  /* Delete confirmation modal */
  #modal-delete{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:1002;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
  .delete-modal-panel{background:#fff;border-radius:16px;padding:24px;width:min(420px,90vw);text-align:center;box-shadow:0 25px 50px -12px rgba(0,0,0,0.25)}
  .delete-modal-icon{font-size:48px;margin-bottom:16px}
  .delete-modal-title{font-size:20px;font-weight:700;color:#0f172a;margin:0 0 8px}
  .delete-modal-desc{font-size:14px;color:#64748b;margin:0 0 8px}
  .delete-modal-name{font-size:15px;font-weight:600;color:#0f172a;background:#f1f5f9;padding:8px 12px;border-radius:8px;margin:12px 0 20px;display:inline-block}
  .delete-modal-actions{display:flex;gap:12px;justify-content:center}
  .delete-modal-actions .btn{padding:12px 24px;font-size:14px}
  /* Highlight assist */
  .ea-highlight-pulse{outline:3px solid #0ea5e9!important;animation:eaPulse 1.2s linear infinite;border-radius:8px}
  @keyframes eaPulse{0%,100%{outline-color:#0ea5e9}50%{outline-color:#fbbf24}}
  /* Variables editor */
  .vars-editor{margin-top:8px;border-top:1px dashed var(--border);padding-top:10px}
  .vgrid{display:grid;grid-template-columns: minmax(140px, 240px) 1fr 1fr minmax(130px, 180px) minmax(130px, 180px);gap:8px;align-items:start}
  .vrow{display:contents}
  .vkey{font-weight:700;padding:6px 8px;background:#f1f5f9;border:1px solid var(--border);border-radius:8px;color:#334155}
  .vinput{border:1px solid var(--border);border-radius:10px;padding:8px 10px;font:inherit;width:100%}
  .vhead{font-size:12px;color:var(--muted);font-weight:700}
  @media (max-width: 900px){ .vgrid{grid-template-columns:1fr} .vkey{margin-bottom:2px} }
      @media (max-width: 1000px){ .frame{grid-template-columns:1fr} .row{grid-template-columns:1fr} }
      
      /* Rich text editor */
      .rich-text-editor {
        min-height: 180px;
        max-height: 500px;
        overflow-y: auto;
        padding: 12px;
        border: 1px solid var(--border);
        border-radius: 10px;
        background: #fff;
        font-family: inherit;
        font-size: 14px;
        line-height: 1.6;
        word-wrap: break-word;
      }
      .rich-text-editor:focus {
        outline: 2px solid #0ea5e9;
        outline-offset: -1px;
      }
      .rich-text-editor:empty:before {
        content: attr(data-placeholder);
        color: #94a3b8;
        white-space: pre-wrap;
        pointer-events: none;
      }
      .rich-text-editor[contenteditable="true"] {
        border-top-left-radius: 0;
        border-top-right-radius: 0;
      }
      /* Better paragraph spacing in rich text */
      .rich-text-editor p {
        margin: 0.5em 0;
      }
      .rich-text-editor p:first-child {
        margin-top: 0;
      }
      .rich-text-editor p:last-child {
        margin-bottom: 0;
      }
    </style>
      /* Login screen */
      #login-screen {
        position: fixed;
        inset: 0;
        background: linear-gradient(135deg, #f8fafc 0%, #e0f2fe 50%, #f0fdf4 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }
      .login-box {
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 20px;
        padding: 40px;
        width: min(420px, 90vw);
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
        text-align: center;
      }
      .login-box h1 {
        margin: 0 0 8px;
        font-size: 28px;
        color: #0f172a;
      }
      .login-box .subtitle {
        margin: 0 0 32px;
        color: var(--muted);
        font-size: 14px;
      }
      .login-box .field {
        margin-bottom: 20px;
        text-align: left;
      }
      .login-box input[type="password"] {
        width: 100%;
        padding: 14px 16px;
        font-size: 16px;
        border: 2px solid var(--border);
        border-radius: 12px;
        transition: border-color 0.2s;
      }
      .login-box input[type="password"]:focus {
        outline: none;
        border-color: var(--teal);
      }
      .login-box .error {
        color: #dc2626;
        font-size: 13px;
        margin-top: 8px;
        display: none;
      }
      .login-box .btn-login {
        width: 100%;
        padding: 14px;
        font-size: 16px;
        font-weight: 700;
        background: var(--teal);
        color: #fff;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        transition: background 0.2s, transform 0.1s;
      }
      .login-box .btn-login:hover {
        background: #047857;
      }
      .login-box .btn-login:active {
        transform: scale(0.98);
      }
      .login-box .lock-icon {
        font-size: 48px;
        margin-bottom: 16px;
      }
      #admin-content {
        display: none;
      }
      #admin-content.authenticated {
        display: block;
      }
  </style>
  </head>
  <body>
    <!-- Login Screen -->
    <div id="login-screen">
      <div class="login-box">
        <div class="lock-icon">üîê</div>
        <h1>Console Admin</h1>
        <p class="subtitle">Acc√®s r√©serv√© aux administrateurs</p>
        <div class="field">
          <label for="admin-password">Mot de passe</label>
          <input type="password" id="admin-password" placeholder="Entrez le mot de passe" autocomplete="current-password" />
          <p class="error" id="login-error">Mot de passe incorrect</p>
        </div>
        <button class="btn-login" id="btn-login">Se connecter</button>
      </div>
    </div>

    <!-- Admin Content (hidden until authenticated) -->
    <div id="admin-content">
    <div class="topbar">
      <div class="brand">Admin (simple) <span id="updated-badge" title="Derni√®re mise √† jour distante du JSON">‚Äì</span>
      </div>
      <div class="spacer"></div>
      <div class="group">
        <button class="btn info" id="btn-import">Importer</button>
        <input id="file" type="file" class="hidden" accept=".json,application/json,.xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" />
        <button class="btn neutral" id="btn-dl-template-xlsx" title="T√©l√©charger un mod√®le Excel (.xlsx) avec les colonnes requises">Mod√®le XLSX</button>
      </div>
      <div class="group">
        <button class="btn indigo" id="btn-export-xlsx" title="Exporter toutes les donn√©es courantes en Excel (.xlsx)">Exporter Excel</button>
        <button class="btn neutral" id="btn-export-download" title="T√©l√©charger le JSON localement">T√©l√©charger JSON</button>
        <button class="btn neutral" id="btn-reload-github" title="Recharger depuis GitHub (√©crase le brouillon local)">‚ü≥ Recharger</button>
        <button class="btn primary" id="btn-gimme-github" title="Publier sur GitHub (configure automatiquement si n√©cessaire)">Publier sur GitHub</button>
      </div>
      <div class="group">
        <button class="btn warning" id="btn-category-colors" title="G√©rer les couleurs des cat√©gories">Cat√©gories</button>
        <button class="btn neutral" id="btn-clean-categories" title="Supprimer les cat√©gories non utilis√©es">Nettoyer cat√©gories</button>
      </div>
      <div class="group">
        <button class="btn danger" id="btn-reset">R√©initialiser</button>
        <button class="btn neutral" id="btn-help">Aide</button>
      </div>
    </div>

    <div id="notice" class="notice"></div>

    <!-- Category Colors Modal -->
    <div id="modal-category-colors">
      <div class="modal-panel">
        <div class="modal-header">
          <strong>Couleurs des cat√©gories</strong>
          <button onclick="document.getElementById('modal-category-colors').style.display='none'" class="modal-close">√ó</button>
        </div>
        <div id="category-colors-body" class="modal-body">
          <p class="modal-note">D√©finir une couleur indicatrice pour chaque cat√©gorie (affich√©e dans le s√©lecteur de mod√®les).</p>
          <div id="category-colors-list"></div>
        </div>
        <div class="modal-footer">
          <button class="btn" onclick="document.getElementById('modal-category-colors').style.display='none'">Fermer</button>
          <button class="btn primary" id="btn-save-category-colors">Enregistrer</button>
        </div>
      </div>
    </div>

    <!-- Help Modal -->
    <div id="modal-help" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:1001;align-items:center;justify-content:center;overflow:auto;padding:20px">
      <div class="modal-panel" style="max-width:900px;margin:auto">
        <div class="modal-header">
          <strong>üìö Guide d'utilisation ‚Äì Console d'administration ECHO</strong>
          <button onclick="document.getElementById('modal-help').style.display='none'" class="modal-close">√ó</button>
        </div>
        <div class="modal-body" style="max-height:70vh;overflow:auto">
          
          <section style="margin-bottom:24px">
            <h3 style="color:#0f172a;font-size:16px;font-weight:700;margin:0 0 12px">üöÄ Prise en main rapide</h3>
            <ol style="margin:0;padding-left:20px;color:#334155;line-height:1.7">
              <li><strong>S√©lectionner un mod√®le</strong> dans la colonne de gauche ou cr√©er un nouveau avec le bouton "Ajouter un mod√®le"</li>
              <li><strong>Modifier les champs</strong> : ID, cat√©gories (FR/EN), titres, descriptions, objets et corps</li>
              <li><strong>Utiliser le formatage riche</strong> : s√©lectionner le texte dans les champs Corps pour activer la barre d'outils (gras, italique, couleurs, etc.)</li>
              <li><strong>Ajouter des variables</strong> : taper <code>&lt;&lt;nom_variable&gt;&gt;</code> directement dans le texte ‚Äì elles seront d√©tect√©es automatiquement</li>
              <li><strong>Enregistrer localement</strong> : les modifications sont sauvegard√©es automatiquement comme brouillon dans votre navigateur</li>
              <li><strong>Publier sur GitHub</strong> : cliquer "Publier sur GitHub" pour d√©ployer les changements en production</li>
            </ol>
          </section>

          <section style="margin-bottom:24px;padding:16px;background:#f0fbfb;border:1px solid #bfe7e3;border-radius:10px">
            <h3 style="color:#145a64;font-size:16px;font-weight:700;margin:0 0 12px">‚ú® Formatage riche du texte</h3>
            <p style="margin:0 0 12px;color:#334155;line-height:1.6">Les champs <strong>Corps (FR)</strong> et <strong>Corps (EN)</strong> supportent le formatage HTML complet.</p>
            <ul style="margin:0;padding-left:20px;color:#334155;line-height:1.7">
              <li><strong>S√©lectionner du texte</strong> pour afficher la barre d'outils flottante</li>
              <li><strong>Formatage de base</strong> : gras, italique, soulign√©, barr√©</li>
              <li><strong>Titres</strong> : H1, H2, H3 pour structurer le contenu</li>
              <li><strong>Listes</strong> : listes √† puces ou num√©rot√©es</li>
              <li><strong>Couleurs</strong> : 
                <ul style="margin-top:4px">
                  <li>Cliquer sur le swatch de couleur pour ouvrir le menu d√©roulant</li>
                  <li>Choisir parmi 8 couleurs pr√©d√©finies ou utiliser l'input personnalis√©</li>
                  <li>Applicable pour la couleur du texte et le surlignage</li>
                </ul>
              </li>
              <li><strong>Variables pr√©serv√©es</strong> : les <code>&lt;&lt;variables&gt;&gt;</code> restent fonctionnelles m√™me avec formatage</li>
            </ul>
            <p style="margin:12px 0 0;color:#0e7490;font-size:13px"><strong>Important :</strong> Le formatage est stock√© en HTML dans le JSON et s'affiche automatiquement dans l'application web principale.</p>
          </section>

          <section style="margin-bottom:24px">
            <h3 style="color:#0f172a;font-size:16px;font-weight:700;margin:0 0 12px">üìù Variables dynamiques</h3>
            <ul style="margin:0;padding-left:20px;color:#334155;line-height:1.7">
              <li><strong>Syntaxe</strong> : <code>&lt;&lt;nom_variable&gt;&gt;</code> (ex: <code>&lt;&lt;nom_client&gt;&gt;</code>, <code>&lt;&lt;numero_dossier&gt;&gt;</code>)</li>
              <li><strong>D√©tection automatique</strong> : les variables sont extraites des champs Objet et Corps</li>
              <li><strong>Noms conseill√©s</strong> : lettres minuscules, chiffres et underscores uniquement (ex: <code>date_echeance</code>)</li>
              <li><strong>Section Variables</strong> : 
                <ul style="margin-top:4px">
                  <li>Affiche toutes les variables d√©tect√©es</li>
                  <li>Permet d'ajouter des valeurs d'exemple (FR et EN)</li>
                  <li>Bouton "Sync variables" pour forcer la mise √† jour de la liste</li>
                </ul>
              </li>
              <li><strong>Bilingue</strong> : chaque variable peut avoir des exemples diff√©rents en fran√ßais et en anglais</li>
            </ul>
          </section>

          <section style="margin-bottom:24px">
            <h3 style="color:#0f172a;font-size:16px;font-weight:700;margin:0 0 12px">üíæ Gestion des donn√©es</h3>
            <div style="display:grid;gap:12px">
              <div style="border:1px solid var(--border);border-radius:8px;padding:12px;background:#fafafa">
                <strong style="color:#334155">Importer</strong>
                <p style="margin:6px 0 0;color:#64748b;font-size:14px;line-height:1.6">
                  ‚Ä¢ Formats accept√©s : JSON ou Excel (.xlsx)<br>
                  ‚Ä¢ T√©l√©charger le mod√®le XLSX vide pour voir la structure attendue<br>
                  ‚Ä¢ L'import remplace le brouillon actuel (attention aux modifications non publi√©es)
                </p>
              </div>
              <div style="border:1px solid var(--border);border-radius:8px;padding:12px;background:#fafafa">
                <strong style="color:#334155">Exporter Excel</strong>
                <p style="margin:6px 0 0;color:#64748b;font-size:14px;line-height:1.6">
                  ‚Ä¢ G√©n√®re un fichier .xlsx contenant tous les mod√®les<br>
                  ‚Ä¢ Utile pour backup, r√©vision hors-ligne ou collaboration<br>
                  ‚Ä¢ Peut √™tre r√©import√© apr√®s modifications
                </p>
              </div>
              <div style="border:1px solid var(--border);border-radius:8px;padding:12px;background:#fafafa">
                <strong style="color:#334155">T√©l√©charger JSON</strong>
                <p style="margin:6px 0 0;color:#64748b;font-size:14px;line-height:1.6">
                  ‚Ä¢ T√©l√©charge le fichier JSON complet avec tous les mod√®les<br>
                  ‚Ä¢ Format utilis√© par l'application web et GitHub<br>
                  ‚Ä¢ Inclut le timestamp de derni√®re mise √† jour
                </p>
              </div>
              <div style="border:1px solid var(--border);border-radius:8px;padding:12px;background:#fafafa">
                <strong style="color:#334155">‚ü≥ Recharger</strong>
                <p style="margin:6px 0 0;color:#64748b;font-size:14px;line-height:1.6">
                  ‚Ä¢ R√©cup√®re la version publi√©e sur GitHub<br>
                  ‚Ä¢ √âcrase le brouillon local ‚Äì toutes modifications non publi√©es seront perdues
                </p>
              </div>
              <div style="border:1px solid var(--border);border-radius:8px;padding:12px;background:#e0f2fe">
                <strong style="color:#0369a1">Publier sur GitHub</strong>
                <p style="margin:6px 0 0;color:#0c4a6e;font-size:14px;line-height:1.6">
                  ‚Ä¢ D√©ploie les modifications sur GitHub et met √† jour l'app web<br>
                  ‚Ä¢ Demande un token GitHub au premier usage (g√©n√©r√© automatiquement)<br>
                  ‚Ä¢ Met √† jour automatiquement le timestamp de publication<br>
                  ‚Ä¢ Les utilisateurs de l'app web voient les changements imm√©diatement apr√®s rechargement
                </p>
              </div>
            </div>
          </section>

          <section style="margin-bottom:24px">
            <h3 style="color:#0f172a;font-size:16px;font-weight:700;margin:0 0 12px">üé® Cat√©gories et organisation</h3>
            <ul style="margin:0;padding-left:20px;color:#334155;line-height:1.7">
              <li><strong>Cat√©gories bilingues</strong> : chaque mod√®le doit avoir une cat√©gorie FR et EN (peuvent √™tre identiques ou traduites)</li>
              <li><strong>S√©lection rapide</strong> : les dropdowns affichent les cat√©gories existantes pour coh√©rence</li>
              <li><strong>Nouvelles cat√©gories</strong> : laisser le dropdown sur "-- Nouvelle cat√©gorie --" et taper dans le champ texte</li>
              <li><strong>Couleurs des cat√©gories</strong> : 
                <ul style="margin-top:4px">
                  <li>Bouton "Cat√©gories" pour d√©finir une couleur par cat√©gorie</li>
                  <li>Affichage visuel dans la liste de mod√®les pour identification rapide</li>
                </ul>
              </li>
              <li><strong>Nettoyer cat√©gories</strong> : supprime les cat√©gories non utilis√©es de la liste globale</li>
            </ul>
          </section>

          <section style="margin-bottom:24px">
            <h3 style="color:#0f172a;font-size:16px;font-weight:700;margin:0 0 12px">üîê S√©curit√© et acc√®s</h3>
            <ul style="margin:0;padding-left:20px;color:#334155;line-height:1.7">
              <li><strong>Authentification requise</strong> : mot de passe demand√© √† chaque session (hash SHA-256)</li>
              <li><strong>Session temporaire</strong> : l'authentification expire √† la fermeture du navigateur (sessionStorage)</li>
              <li><strong>Acc√®s depuis l'app principale</strong> : bouton Admin discret en bas √† gauche (visible pour tous, prot√©g√© par mot de passe)</li>
              <li><strong>Brouillon local</strong> : toutes les modifications sont sauvegard√©es dans le navigateur (localStorage)</li>
              <li><strong>Pas de synchronisation automatique</strong> : les changements ne sont visibles publiquement qu'apr√®s publication GitHub</li>
              <li><strong>Token GitHub</strong> : 
                <ul style="margin-top:4px">
                  <li>Stock√© localement dans votre navigateur (jamais envoy√© ailleurs que GitHub)</li>
                  <li>N√©cessaire uniquement pour la publication</li>
                  <li>Configur√© automatiquement au premier clic sur "Publier sur GitHub"</li>
                </ul>
              </li>
              <li><strong>Indicateur de sauvegarde</strong> : badge visuel en bas √† droite confirme chaque enregistrement local</li>
            </ul>
          </section>

          <section style="margin-bottom:24px;padding:16px;background:#fef2f2;border:1px solid #fecaca;border-radius:10px">
            <h3 style="color:#991b1b;font-size:16px;font-weight:700;margin:0 0 12px">‚ö†Ô∏è Bonnes pratiques</h3>
            <ul style="margin:0;padding-left:20px;color:#7f1d1d;line-height:1.7">
              <li><strong>Publier r√©guli√®rement</strong> pour √©viter de perdre du travail en cas de fermeture accidentelle</li>
              <li><strong>Tester dans l'app web</strong> apr√®s publication pour v√©rifier le rendu des formatages</li>
              <li><strong>Utiliser des ID uniques</strong> : lettres, chiffres et underscores, pas d'espaces ni caract√®res sp√©ciaux</li>
              <li><strong>Nommer clairement les variables</strong> pour que les utilisateurs comprennent leur fonction</li>
              <li><strong>Exporter en Excel</strong> avant modifications majeures comme backup de s√©curit√©</li>
              <li><strong>√âviter de recharger depuis GitHub</strong> si vous avez des modifications non publi√©es</li>
              <li><strong>Confirmer avant suppression</strong> : un modal demande confirmation avec le nom du mod√®le ‚Äì action irr√©versible</li>
            </ul>
          </section>

          <section style="margin-bottom:12px">
            <h3 style="color:#0f172a;font-size:16px;font-weight:700;margin:0 0 12px">üêõ D√©pannage</h3>
            <div style="display:grid;gap:10px">
              <details style="border:1px solid var(--border);border-radius:8px;padding:12px;background:#fff">
                <summary style="cursor:pointer;font-weight:700;color:#334155">Les variables ne s'affichent pas correctement</summary>
                <p style="margin:8px 0 0;color:#64748b;font-size:14px;line-height:1.6">
                  ‚Ä¢ Cliquer sur "Sync variables" pour forcer la d√©tection<br>
                  ‚Ä¢ V√©rifier la syntaxe : <code>&lt;&lt;nom_variable&gt;&gt;</code> avec deux chevrons de chaque c√¥t√©<br>
                  ‚Ä¢ Pas d'espaces √† l'int√©rieur des chevrons
                </p>
              </details>
              <details style="border:1px solid var(--border);border-radius:8px;padding:12px;background:#fff">
                <summary style="cursor:pointer;font-weight:700;color:#334155">Le formatage ne s'affiche pas dans l'app web</summary>
                <p style="margin:8px 0 0;color:#64748b;font-size:14px;line-height:1.6">
                  ‚Ä¢ S'assurer d'avoir publi√© sur GitHub (les brouillons locaux ne sont pas visibles publiquement)<br>
                  ‚Ä¢ Les utilisateurs doivent rafra√Æchir la page pour voir les nouveaux changements<br>
                  ‚Ä¢ Le cache du navigateur est automatiquement ignor√© lors du chargement des templates
                </p>
              </details>
              <details style="border:1px solid var(--border);border-radius:8px;padding:12px;background:#fff">
                <summary style="cursor:pointer;font-weight:700;color:#334155">Erreur lors de la publication GitHub</summary>
                <p style="margin:8px 0 0;color:#64748b;font-size:14px;line-height:1.6">
                  ‚Ä¢ V√©rifier que le token GitHub est valide (peut expirer)<br>
                  ‚Ä¢ Si demand√©, autoriser la cr√©ation automatique du token<br>
                  ‚Ä¢ En cas d'√©chec r√©p√©t√©, utiliser "T√©l√©charger JSON" puis publier manuellement via GitHub web
                </p>
              </details>
              <details style="border:1px solid var(--border);border-radius:8px;padding:12px;background:#fff">
                <summary style="cursor:pointer;font-weight:700;color:#334155">Mes modifications ont disparu</summary>
                <p style="margin:8px 0 0;color:#64748b;font-size:14px;line-height:1.6">
                  ‚Ä¢ V√©rifier si quelqu'un a publi√© sur GitHub ou cliqu√© sur "‚ü≥ Recharger" (√©crase le brouillon local)<br>
                  ‚Ä¢ Les brouillons sont li√©s au navigateur ‚Äì changer d'ordinateur ou de navigateur recharge depuis GitHub<br>
                  ‚Ä¢ Toujours publier sur GitHub pour sauvegarder d√©finitivement
                </p>
              </details>
            </div>
          </section>

        </div>
        <div class="modal-footer">
          <button class="btn primary" onclick="document.getElementById('modal-help').style.display='none'">Fermer</button>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="modal-delete">
      <div class="delete-modal-panel">
        <div class="delete-modal-icon">üóëÔ∏è</div>
        <div class="delete-modal-title">Supprimer ce mod√®le ?</div>
        <div class="delete-modal-desc">Cette action est irr√©versible. Le mod√®le sera d√©finitivement supprim√©.</div>
        <div class="delete-modal-name" id="delete-template-name">‚Äî</div>
        <div class="delete-modal-actions">
          <button class="btn" id="btn-cancel-delete">Annuler</button>
          <button class="btn danger" id="btn-confirm-delete">Supprimer</button>
        </div>
      </div>
    </div>

    <!-- Save Indicator -->
    <div id="save-indicator" class="save-indicator">
      <span class="dot"></span>
      <span class="save-text">Sauvegard√©</span>
    </div>

    <div class="frame">
      <aside class="panel">
        <div class="head"><strong>Mod√®les</strong><button class="btn" id="btn-new">Ajouter un mod√®le</button></div>
        <div class="body">
          <div class="search"><input id="search" placeholder="Rechercher‚Ä¶" /></div>
          <div id="list" class="list"></div>
        </div>
      </aside>

      <main class="panel">
        <div class="head"><strong id="hdr">√âditeur</strong>
          <div class="toolbar">
            <button class="btn" id="btn-delete">Supprimer</button>
          </div>
        </div>
        <div class="body" id="editor">
          <div class="row">
            <div class="field span-2"><label>ID</label><input id="tpl-id" placeholder="ex: welcome_email" title="Identifiant unique (lettres, chiffres, underscore)" /></div>
          </div>
          <div class="row">
            <div class="field">
              <label>Cat√©gorie (FR)</label>
              <select id="tpl-cat-fr-select" title="S√©lectionner une cat√©gorie existante">
                <option value="">-- Nouvelle cat√©gorie --</option>
              </select>
              <input id="tpl-cat-fr" placeholder="ex: Service client" title="Cat√©gorie en fran√ßais" style="margin-top:6px" />
            </div>
            <div class="field">
              <label>Category (EN)</label>
              <select id="tpl-cat-en-select" title="Select an existing category">
                <option value="">-- New category --</option>
              </select>
              <input id="tpl-cat-en" placeholder="ex: Customer Care" title="Category in English" style="margin-top:6px" />
            </div>
          </div>
          <div class="row">
            <div class="field"><label>Titre (FR)</label><input id="tpl-title-fr" placeholder="ex: Bienvenue ‚Äì Nouveau client" title="Titre en fran√ßais" /></div>
            <div class="field"><label>Titre (EN)</label><input id="tpl-title-en" placeholder="ex: Welcome ‚Äì New customer" title="Title in English" /></div>
          </div>
          <div class="row">
            <div class="field"><label>Description (FR)</label><input id="tpl-desc-fr" placeholder="ex: Courriel de bienvenue pour un nouveau client" title="Description en fran√ßais" /></div>
            <div class="field"><label>Description (EN)</label><input id="tpl-desc-en" placeholder="ex: Welcome email for a new customer" title="Description in English" /></div>
          </div>
          <div class="row">
            <div class="field"><label>Objet (FR)</label><input id="tpl-subj-fr" placeholder="ex: Bienvenue chez ECHO !" title="Objet en fran√ßais" /></div>
            <div class="field"><label>Objet (EN)</label><input id="tpl-subj-en" placeholder="ex: Welcome to ECHO!" title="Subject in English" /></div>
          </div>
          <div class="row">
            <div class="field">
              <label>Corps (FR)</label>
              <div id="tpl-body-fr" class="rich-text-editor" data-placeholder="Bonjour <<nom_client>>,&#10;&#10;Merci pour votre confiance‚Ä¶"></div>
            </div>
            <div class="field">
              <label>Corps (EN)</label>
              <div id="tpl-body-en" class="rich-text-editor" data-placeholder="Hello <<customer_name>>,&#10;&#10;Thank you for your trust‚Ä¶"></div>
            </div>
          </div>
          <div class="field">
            <label>Variables d√©tect√©es (automatique)</label>
            <button class="btn" id="btn-sync-vars" title="Synchroniser la liste des variables avec le texte">Sync variables</button>
            <div id="vars" class="chips"></div>
            <div id="vars-editor" class="vars-editor"></div>
          </div>
        </div>
      </main>
    </div>

    <script src="../assets/rich-text-toolbar.js"></script>
    <script src="../assets/admin-simple.js"></script>
    <script>
      // Lightweight badge population: fetch raw main JSON headers quickly
      (async function(){
        try {
          const repo = document.querySelector('meta[name="gh-repo"]')?.content || 'snarky1980/echo-bt-ctd-gestion';
          const origin = window.location.origin && window.location.origin !== 'null' ? window.location.origin.replace(/\/$/, '') : '';
          const basePath = (window.location.pathname || '').replace(/\/[^\/]*$/, '');
          const urls = [];
          const addUrl = (candidate) => { if (!candidate || urls.includes(candidate)) return; urls.push(candidate); };
          // Try published gh-pages first for latest timestamp
          if (window.location.hostname === 'snarky1980.github.io') {
            addUrl(`https://snarky1980.github.io/echo-bt-ctd-gestion/complete_email_templates.json?t=${Date.now()}`);
          }
          addUrl(`../complete_email_templates.json?t=${Date.now()}`);
          if (origin) {
            if (basePath && basePath !== '') addUrl(`${origin}${basePath}/complete_email_templates.json?t=${Date.now()}`);
            addUrl(`${origin}/complete_email_templates.json?t=${Date.now()}`);
          }
          addUrl(`https://raw.githubusercontent.com/${repo}/gh-pages/complete_email_templates.json?t=${Date.now()}`);
          addUrl(`https://raw.githubusercontent.com/${repo}/main/complete_email_templates.json?t=${Date.now()}`);
          let json = null;
          for (const url of urls) {
            try {
              const resp = await fetch(url, { cache:'no-store', headers: { 'Cache-Control': 'no-cache' } });
              if (!resp.ok) continue;
              json = await resp.json();
              console.log('[Badge] Loaded timestamp from:', url);
              break;
            } catch {}
          }
          if (!json) return;
          const ts = json?.metadata?.updatedAt || json?.metadata?.generatedAt || null;
          if(ts){
            const badge = document.getElementById('updated-badge');
            badge.textContent = new Date(ts).toLocaleString('fr-FR',{ hour12:false });
            badge.style.display = 'inline-block';
            console.log('[Badge] Updated with timestamp:', ts);
          } else {
            console.log('[Badge] No timestamp found in metadata');
          }
        } catch(e){ console.error('[Badge] Error:', e); }
      })();
    </script>
    </div><!-- end #admin-content -->
  </body>
  </html>
